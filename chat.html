<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LomyChat â€” Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<style>
    /* --- STYLES TO MATCH CHATLIST.HTML --- */
    :root {
        --background: #f1f5f9; --surface: #ffffff; --glass-bg: rgba(255, 255, 255, 0.6);
        --glass-border: rgba(0, 0, 0, 0.1); --primary: #7c3aed; --secondary: #db2777;
        --text-primary: #1e293b; --text-secondary: #475569; --shadow: rgba(0, 0, 0, 0.1);
        --bubble-outgoing-bg: linear-gradient(135deg, var(--primary), var(--secondary));
        --bubble-incoming-bg: #ffffff;
        --bubble-outgoing-text: #ffffff;
        --bubble-incoming-text: #1e293b;
    }
    @media (prefers-color-scheme: dark) {
        :root {
            --background: #0f172a; --surface: #1e293b; --glass-bg: rgba(30, 41, 59, 0.5);
            --glass-border: rgba(255, 255, 255, 0.1); --primary: #8b5cf6; --secondary: #ec4899;
            --text-primary: #f8fafc; --text-secondary: #94a3b8; --shadow: rgba(0, 0, 0, 0.25);
            --bubble-incoming-bg: #1e293b;
            --bubble-incoming-text: #f8fafc;
        }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
        margin:0; font-family: 'Poppins', sans-serif;
        background-color: var(--background); color: var(--text-primary);
        overflow:hidden;
    }
    .glassmorphism { background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); }

    /* Header */
    header {
        position:sticky; top:0; z-index:10;
        padding: 12px 16px;
        display:flex; align-items:center; gap:12px;
        min-height:64px;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--glass-border);
    }
    .back-btn, .icon-btn {
        border:0; background:transparent; color: var(--text-primary);
        width:40px; height:40px; border-radius: 50%;
        cursor:pointer; display:grid; place-items:center;
        transition: background-color .2s;
    }
    .back-btn:hover, .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
    @media (prefers-color-scheme: dark){
        .back-btn:hover, .icon-btn:hover { background-color: rgba(255,255,255,0.08); }
    }
    .avatar {
        width:44px; height:44px; border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        display:grid; place-items:center; font-weight:600; font-size: 18px; color:#fff;
    }
    .title { font-weight:600; font-size:18px; }
    .subtitle { font-size:12px; color: var(--text-secondary); }
    .ico{width:24px;height:24px;display:block}

    /* Message Area */
    .app { display:flex; flex-direction:column; height: 100vh; }
    .msgs { flex:1; overflow:auto; padding: 16px 16px 150px 16px; }
    .row { display:flex; gap:8px; margin:8px 0; align-items:flex-end; }
    .row.me { justify-content:flex-end; }
    .bubble {
        max-width:75%; padding:10px 14px;
        border-radius:20px;
        position:relative; overflow-wrap:anywhere;
        box-shadow: 0 4px 12px var(--shadow);
    }
    .row.me .bubble {
        background: var(--bubble-outgoing-bg);
        color: var(--bubble-outgoing-text);
        border-radius:20px 20px 4px 20px;
    }
    .row:not(.me) .bubble {
        background: var(--bubble-incoming-bg);
        color: var(--bubble-incoming-text);
        border-radius:20px 20px 20px 4px;
    }
    .bubble .time { display:block; font-size:11px; opacity:.8; margin-top:6px; text-align: right; }
    .bubble img { max-width:70vw; border-radius:16px; display:block; margin-top: 4px; }
    .row.me .time { color: rgba(255,255,255,0.8); }

    /* Composer */
    .composer-wrapper {
        position:fixed; left:0; right:0; bottom:0;
        padding: 12px;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-top: 1px solid var(--glass-border);
    }
    .composer {
        display:flex; align-items:flex-end; gap:8px;
        max-width:820px; margin: 0 auto;
    }
    .input-container {
        flex:1; display:flex; align-items:center;
        background: var(--surface);
        border-radius: 24px;
        padding: 4px;
        box-shadow: 0 4px 12px var(--shadow);
    }
    .input-container textarea {
        flex:1; border:none; outline:none; padding: 8px 12px;
        width:100%; background:transparent; color:inherit;
        resize:none; min-height:40px; line-height:1.4;
        font-family: 'Poppins', sans-serif;
    }
    .composer .icon-btn { color: var(--text-secondary); }
    .send-btn {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border:none; color:white; border-radius: 50%;
        cursor:pointer; display:grid; place-items:center;
        width:48px; height:48px; flex-shrink: 0;
        box-shadow: 0 4px 12px var(--shadow);
        transition: transform .2s, opacity .2s;
    }
    .send-btn:hover { transform: scale(1.05); }
    .send-btn:disabled { opacity:.5; cursor:not-allowed; transform: scale(1); }
    input[type=file] { display: none; }

    /* Voice Note Player */
    .voice-note { display: flex; align-items: center; gap: 10px; min-width: 220px; }
    .play-pause-btn {
        background: var(--primary); border: none; border-radius: 50%;
        width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
        cursor: pointer; flex-shrink: 0; color: white;
    }
    .row:not(.me) .play-pause-btn { background-color: var(--primary); }
    .row.me .play-pause-btn { background-color: white; color: var(--primary); }
    .waveform { flex-grow: 1; display: flex; align-items: center; height: 30px; gap: 2px; }
    .waveform-bar { background-color: var(--text-secondary); width: 3px; border-radius: 3px; opacity: 0.6; }
    .row.me .waveform-bar { background-color: rgba(255,255,255,.7); }
    .duration { font-size: 12px; font-weight: 500; color: var(--text-secondary); flex-shrink: 0; }
    .row.me .duration { color: rgba(255,255,255,.8); }
    .hidden-audio { display: none; }
    
    /* --- NEW --- Voice Recording Animation */
    .composer .icon-btn.recording {
        background-color: var(--primary) !important;
        color: white !important;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(124, 58, 237, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(124, 58, 237, 0); }
    }
</style>
</head>
<body>

<div class="app">
    <header>
        <button class="back-btn" id="backBtn" title="Back to Chats">
            <svg class="ico" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <div id="avatar" class="avatar"></div>
        <div>
            <div id="chatTitle" class="title">Loading...</div>
            <div id="chatSub" class="subtitle"></div>
        </div>
        <div class="ml-auto flex items-center gap-2">
            <button class="icon-btn" id="callBtn" title="Call">
                <svg class="ico" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
            </button>
             <button class="icon-btn" id="viewProfileBtn" title="View Profile">
                <svg class="ico" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            </button>
        </div>
    </header>

    <div id="msgs" class="msgs"></div>

    <div class="composer-wrapper">
        <!-- --- NEW --- Preview bar for the sound wave -->
        <div id="previewBar" style="display: none; max-width: 820px; margin: 0 auto 8px auto; padding: 8px; background: var(--surface); border-radius: 16px; align-items: center; gap: 8px; box-shadow: 0 4px 12px var(--shadow);">
            <canvas id="waveCanvas" style="width: 100%; height: 40px;"></canvas>
            <button id="cancelRecBtn" class="icon-btn" title="Cancel Recording">
                <svg class="ico" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        
        <div class="composer">
            <div class="input-container">
                <button id="galleryBtn" class="icon-btn" title="Attach Image">
                     <svg class="ico" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                </button>
                <textarea id="msgInput" placeholder="Message..." rows="1"></textarea>
                <button id="micBtn" class="icon-btn" title="Record Voice">
                    <svg class="ico" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                </button>
            </div>
            <button id="sendBtn" class="send-btn" title="Send" disabled>
                <svg class="ico" style="width:26px; height:26px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
            </button>
        </div>
    </div>
</div>

<input id="galleryInput" type="file" accept="image/*"/>

<!-- Dummy user picker overlay -->
<div id="dummyOverlay" style="display:none; position:fixed; inset:0; z-index:20; align-items:center; justify-content:center; backdrop-filter: blur(6px);">
  <div style="background:var(--surface); border:1px solid var(--glass-border); border-radius:16px; padding:16px; width:min(420px, 92vw); box-shadow:0 18px 40px rgba(0,0,0,.35);">
    <h3 class="text-lg font-bold mb-1">Pick a test chat</h3>
    <p class="text-sm opacity-80 mb-3">This is just for testing.</p>
    <div class="grid gap-2">
      <button style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--glass-border); background:var(--surface); cursor:pointer;" data-uid="dummy1" data-cid="conv_dummy1">Chat with Dummy One</button>
      <button style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--glass-border); background:var(--surface); cursor:pointer;" data-uid="dummy2" data-cid="conv_dummy2">Chat with Dummy Two</button>
    </div>
  </div>
</div>

<!-- Call modal -->
<div id="callModal" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; z-index:40;">
  <div id="callBackdrop" style="position:absolute; inset:0; background:rgba(0,0,0,.5);"></div>
  <div style="position:relative; background:var(--surface); border:1px solid var(--glass-border); border-radius:16px; padding:16px; width:min(460px, 92vw); box-shadow:0 18px 40px rgba(0,0,0,.35);">
    <h3 class="font-bold text-lg mb-2">Start a call</h3>
    <p id="callWho" class="text-sm opacity-80 mb-3">Ready</p>
    <div class="grid gap-2 mb-3">
      <video id="selfVideo" autoplay playsinline muted style="width:100%; border-radius:12px; background:#000;"></video>
      <video id="remoteVideo" autoplay playsinline style="width:100%; border-radius:12px; background:#000;"></video>
    </div>
    <div class="flex gap-3">
      <button id="startAudio" class="px-4 py-2 rounded-md bg-blue-600 text-white">Audio</button>
      <button id="startVideo" class="px-4 py-2 rounded-md bg-green-600 text-white">Video</button>
      <button id="hangup" class="ml-auto px-4 py-2 rounded-md bg-rose-600 text-white">Hang up</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, doc, collection, getDoc, setDoc, addDoc, onSnapshot, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
  
    const firebaseConfig = {
        apiKey: "AIzaSyAW6rJOip8zSZ4dUrU5NroTOVDju4gdTh0",
        authDomain: "lomychat.firebaseapp.com",
        projectId: "lomychat",
        storageBucket: "lomychat.appspot.com",
        messagingSenderId: "556633248856",
        appId: "1:556633248856:web:fd93d8fe7a825c2cd0a62d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

  const $ = s => document.querySelector(s);
  const msgsEl = $("#msgs");
  const msgInput = $("#msgInput");
  const sendBtn = $("#sendBtn");
  const backBtn = $("#backBtn");
  const viewProfileBtn = $("#viewProfileBtn");
  const micBtn = $("#micBtn");
  const galleryBtn = $("#galleryBtn");
  const galleryInput = $("#galleryInput");
  const dummyOverlay = $("#dummyOverlay");
  const callBtn = $("#callBtn");
  const callModal = $("#callModal");
  const callBackdrop = $("#callBackdrop");
  const hangupBtn = $("#hangup");
  const selfVideo = $("#selfVideo");
  const remoteVideo = $("#remoteVideo");
  const callWho = $("#callWho");
  const previewBar = $("#previewBar");
  const waveCanvas = $("#waveCanvas");
  const cancelRecBtn = $("#cancelRecBtn");

  const qp = new URLSearchParams(location.search);
  let CONV_ID = qp.get('c') || '';
  let OTHER_UID = qp.get('u') || '';
  let me = null;
  
  if(!CONV_ID || !OTHER_UID){
    dummyOverlay.style.display = 'flex';
    dummyOverlay.querySelectorAll('button').forEach(btn=>{
      btn.onclick = ()=>{
        CONV_ID = btn.dataset.cid;
        OTHER_UID = btn.dataset.uid;
        dummyOverlay.style.display = 'none';
        startApp();
      };
    });
  }

  backBtn.onclick = ()=> location.href='chatlist.html';
  viewProfileBtn.onclick = ()=> {
    if(!me) return;
    location.href = `profile-other.html?uid=${encodeURIComponent(OTHER_UID)}`;
  };
  
  function initialsFromUsername(u){ return (u || 'U').charAt(0).toUpperCase(); }
  function scrollToBottom(){ msgsEl.scrollTop = msgsEl.scrollHeight; }
  function fmtTime(ts){
    if (!ts) return '';
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function bubbleHTML(id, m, isMe){
    const time = fmtTime(m.createdAt);
    const rowClass = isMe ? 'me' : '';
    let contentHTML = '';

    if (m.type === 'image') {
      const imgContent = m.content ? `<img src="${m.content}" alt="photo">` : `<span>Uploading...</span>`;
      contentHTML = `${imgContent}<span class="time">${time}</span>`;
    } else if (m.type === 'audio') {
        if (!m.content) {
             contentHTML = `<span>Processing voice...</span><span class="time">${time}</span>`;
        } else {
            contentHTML = `
                <div class="voice-note">
                    <button class="play-pause-btn" aria-label="Play"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
                    <div class="waveform"></div>
                    <span class="duration">0:00</span>
                    <audio class="hidden-audio" src="${m.content}" preload="metadata"></audio>
                </div>
                <span class="time">${time}</span>
            `;
        }
    } else {
      contentHTML = `${(m.content || '').replace(/</g, '&lt;')} <span class="time">${time}</span>`;
    }
    return `<div class="row ${rowClass}" data-id="${id}"><div class="bubble">${contentHTML}</div></div>`;
  }
  
  function updateSendEnabled(){ sendBtn.disabled = !msgInput.value.trim(); }
  function autoResize(){
    msgInput.style.height='auto';
    msgInput.style.height = `${Math.min(msgInput.scrollHeight, 120)}px`;
  }
  msgInput.addEventListener('input', ()=>{ autoResize(); updateSendEnabled(); });
  msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); }});
  sendBtn.onclick = sendText;
  galleryBtn.onclick = () => galleryInput.click();
  galleryInput.onchange = () => { if (galleryInput.files[0]) uploadImage(galleryInput.files[0]); };


  onAuthStateChanged(auth, (user)=>{
    if (user) {
        me = user;
        if(CONV_ID && OTHER_UID) startApp();
    } else {
        // Redirect to login if not authenticated
        // window.location.href = 'index.html';
    }
  });

  async function startApp(){
    try {
      const userDoc = await getDoc(doc(db,'users', OTHER_UID));
      const userData = userDoc.exists() ? userDoc.data() : {};
      $('#chatTitle').textContent = userData.displayName || 'Unknown User';
      $('#chatSub').textContent = userData.isOnline ? 'Online' : 'Offline';
      $('#avatar').textContent = initialsFromUsername(userData.displayName);
    } catch(e) {
      console.error("Failed to load user data:", e);
      $('#chatTitle').textContent = 'Error';
    }

    const q = query(collection(db,'conversations', CONV_ID, 'messages'), orderBy('createdAt','asc'));
    onSnapshot(q, (snap)=>{
      let html = '';
      snap.forEach(d=>{
        const m = d.data();
        html += bubbleHTML(d.id, m, m.from === me.uid);
      });
      msgsEl.innerHTML = html;
      initializeAudioPlayers();
      setTimeout(scrollToBottom, 100);
    });
  }

  async function sendText(){
    const text = msgInput.value.trim();
    if(!text) return;
    msgInput.value=''; autoResize(); updateSendEnabled();
    try {
      const now = serverTimestamp();
      const mref = collection(db,'conversations', CONV_ID, 'messages');
      const cref = doc(db,'conversations', CONV_ID);
      await addDoc(mref, {
        type:'text', content:text, from: me.uid, to: OTHER_UID,
        createdAt: now, status:'sent'
      });
      await setDoc(cref, { 
        lastMessage: { text: text, timestamp: now, senderId: me.uid },
        participants: [me.uid, OTHER_UID] 
      }, { merge:true });
      scrollToBottom();
    } catch(e) { console.error("Send failed:", e); alert('Message could not be sent.'); }
  }

  async function uploadImage(file) {
    if (!file) return;
    const apiKey = '55c545a2a2f8a22a0213d7cdf09d76c0';
    const formData = new FormData();
    formData.append('image', file);
    const now = serverTimestamp();
    const mref = collection(db,'conversations', CONV_ID, 'messages');
    const cref = doc(db, 'conversations', CONV_ID);
    const placeholder = await addDoc(mref, {
        type: 'image', content: '', from: me.uid, to: OTHER_UID,
        createdAt: now, status: 'sending'
    });
    try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData });
        const result = await response.json();
        if (result.success) {
            await setDoc(placeholder, { content: result.data.url, status: 'sent' }, { merge: true });
            await setDoc(cref, { 
                lastMessage: { text: '[Photo]', timestamp: now, senderId: me.uid },
                participants: [me.uid, OTHER_UID]
             }, { merge: true });
        } else { throw new Error(result.error.message); }
    } catch (e) {
        console.error("Image upload failed:", e);
        await setDoc(placeholder, { content: 'Upload Failed', status: 'failed' }, { merge: true });
    }
  }
  
    // --- VOICE RECORDING AND VISUALIZER SECTION ---
    let mediaRecorder, recChunks = [], audioCtx, analyser, rafId;
    let isCancelled = false;

    micBtn.onclick = async ()=>{
        if(mediaRecorder && mediaRecorder.state==='recording'){ 
            mediaRecorder.stop();
            return; 
        }
        try{
            isCancelled = false;
            const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
            previewBar.style.display = 'flex';
            micBtn.classList.add('recording');
            startVisualizer(stream);
            recChunks = []; 
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recChunks.push(e.data); };
            mediaRecorder.onstop = async ()=>{
                previewBar.style.display = 'none';
                micBtn.classList.remove('recording');
                stopVisualizer();
                stream.getTracks().forEach(t=>t.stop());
                if (!isCancelled) {
                    const audioBlob = new Blob(recChunks, { type:'audio/webm' });
                    if(audioBlob.size > 1000) uploadAudio(audioBlob);
                }
            };
            mediaRecorder.start();
        } catch(e) {
            alert('Mic permission denied or error: ' + e.message);
            previewBar.style.display = 'none';
            micBtn.classList.remove('recording');
        }
    };

    cancelRecBtn.onclick = () => {
        if(mediaRecorder && mediaRecorder.state === 'recording') {
            isCancelled = true;
            mediaRecorder.stop();
        }
    };

    async function uploadAudio(blob) {
        const now = serverTimestamp();
        const mref = collection(db, 'conversations', CONV_ID, 'messages');
        const cref = doc(db, 'conversations', CONV_ID);
        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                await addDoc(mref, {
                    type: 'audio', content: event.target.result, from: me.uid, to: OTHER_UID,
                    createdAt: now, status: 'sent'
                });
                await setDoc(cref, { 
                    lastMessage: { text: '[Voice Note]', timestamp: now, senderId: me.uid },
                    participants: [me.uid, OTHER_UID] 
                }, { merge: true });
                scrollToBottom();
            } catch (e) { console.error("Audio save failed:", e); }
        };
        reader.readAsDataURL(blob);
    }
    
    function startVisualizer(stream){
        stopVisualizer();
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);
        const buffer = new Uint8Array(analyser.frequencyBinCount);
        const ctx = waveCanvas.getContext('2d');
        const style = getComputedStyle(document.body);
        const primaryColor = style.getPropertyValue('--primary').trim();
        function draw(){
            rafId = requestAnimationFrame(draw);
            analyser.getByteFrequencyData(buffer);
            const W = waveCanvas.width;
            const H = waveCanvas.height;
            ctx.clearRect(0,0,W,H);
            const barWidth = (W / buffer.length) * 1.5;
            let x = 0;
            for(let i=0; i < buffer.length; i++) {
                const barHeight = (buffer[i] / 255) * H;
                ctx.fillStyle = primaryColor;
                ctx.fillRect(x, H - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }
        draw();
    }

    function stopVisualizer(){
        if(rafId) cancelAnimationFrame(rafId);
        if(audioCtx) audioCtx.close().catch(()=>{});
        const ctx = waveCanvas.getContext('2d');
        if (ctx) ctx.clearRect(0,0, waveCanvas.width, waveCanvas.height);
    }
    
    // --- AUDIO PLAYER & CALLS ---
    function initializeAudioPlayers() {
        document.querySelectorAll('.voice-note:not([data-initialized])').forEach(player => {
            player.dataset.initialized = 'true';
            const audio = player.querySelector('.hidden-audio');
            const durationEl = player.querySelector('.duration');
            const waveformEl = player.querySelector('.waveform');
            const playBtn = player.querySelector('.play-pause-btn');
            waveformEl.innerHTML = Array(30).fill(0).map(() => `<div class="waveform-bar" style="height:${Math.floor(Math.random()*80)+15}%"></div>`).join('');
            audio.onloadedmetadata = () => {
                const m = String(Math.floor(audio.duration / 60));
                const s = String(Math.floor(audio.duration % 60)).padStart(2, '0');
                durationEl.textContent = `${m}:${s}`;
            };
            playBtn.onclick = () => {
                document.querySelectorAll('.hidden-audio').forEach(aud => {
                    if (aud !== audio) aud.pause(); // Pause other voice notes
                });
                if (audio.paused) {
                    audio.play();
                    playBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h4v12H6zm8 0h4v12h-4z"/></svg>`;
                } else {
                    audio.pause();
                    playBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
                }
            };
            audio.onended = () => { playBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`; };
        });
    }

    callBtn.onclick = ()=>{
        callWho.textContent = `Call ${$('#chatTitle')?.textContent || 'User'}`;
        callModal.style.display = 'flex';
    };
    const endCall = () => {
        callModal.style.display = 'none';
        [selfVideo.srcObject, remoteVideo.srcObject].forEach(stream => {
            stream?.getTracks().forEach(track => track.stop());
        });
        selfVideo.srcObject = null;
        remoteVideo.srcObject = null;
    };
    callBackdrop.onclick = endCall;
    hangupBtn.onclick = endCall;
</script>
</body>
</html>
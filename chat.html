<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LomyChat â€” Chat (Calls + Profiles + Real/Dummy switch)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --text:#0b1220; --muted:#667085; --divider:#e6eaf0; --card:#ffffff;
    --bubble-default:#ffffff; --bubble-text:#0b1220;
    --bubble-sending:#fecaca; --bubble-delivered:#1e3a8a; --bubble-seen:#2563eb;
    --bubble-strong-text:#ffffff;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --text:#e7f0f7; --muted:#9db4c7; --divider:#17212b; --card:#0b121a;
      --bubble-default:#111827; --bubble-text:#e7f0f7;
      --bubble-sending:#b91c1c; --bubble-delivered:#1e3a8a; --bubble-seen:#2563eb;
      --bubble-strong-text:#ffffff;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;color:var(--text);font:15px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; overflow:hidden;}

  /* Fixed background */
  .bg{ position:fixed; inset:0; z-index:-1; background-size:cover; background-position:center; }
  @media (prefers-color-scheme: light){ .bg{ background-image:url('https://i.postimg.cc/Y0Wb7Vfc/IMG-20250816-WA0070.jpg'); } }
  @media (prefers-color-scheme: dark){ .bg{ background-image:url('https://i.postimg.cc/QCT9nq8d/IMG-20250816-WA0069.jpg'); } }

  header{
    position:sticky; top:0; z-index:5; backdrop-filter: blur(8px);
    background:linear-gradient(90deg, rgba(14,165,233,.9), rgba(34,197,94,.9));
    color:white; padding:8px 12px; display:flex; align-items:center; gap:10px;
    box-shadow:0 4px 14px rgba(0,0,0,.2); min-height:56px;
  }
  .back,.iconBtn{
    border:0;background:rgba(255,255,255,.18);color:#fff;width:40px;height:40px;border-radius:12px;cursor:pointer;
    display:grid;place-items:center; transition:opacity .2s;
  }
  .back:hover,.iconBtn:hover{opacity:.9}
  .chatHead{display:flex;align-items:center;gap:10px;min-width:0}
  .avatar{ width:40px;height:40px;border-radius:12px;background:rgba(255,255,255,.2); display:grid;place-items:center;font-weight:900; color:#fff; overflow:hidden; }
  .title{font-weight:900;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{font-size:12px;opacity:.95}
  .profileBtn{
    border:0;background:white;color:#0b1220;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer; display:flex; align-items:center; gap:8px;
  }
  @media (prefers-color-scheme: dark){ .profileBtn{ background:#111827; color:#e7f0f7; border:1px solid #1f2937; } }
  .ico{width:22px;height:22px;display:block}

  .app{ display:flex; flex-direction:column; height:100vh; }
  .msgs{ flex:1; overflow:auto; padding:14px 10px 172px 10px; }

  .row{display:flex;gap:6px;margin:6px 0;align-items:flex-end}
  .row.me{justify-content:flex-end}
  .bubble{
    max-width:78%; background:var(--bubble-default); color:var(--bubble-text);
    padding:10px 12px; border-radius:16px 16px 16px 6px; box-shadow:0 2px 6px rgba(0,0,0,.1);
    position:relative; overflow-wrap:anywhere;
  }
  .row.me .bubble{ border-radius:16px 16px 6px 16px; }
  .bubble .time{ display:block; font-size:11px; opacity:.85; margin-top:6px; }
  .bubble img{ max-width:72vw; border-radius:12px; display:block }

  .bubble::after{ content:''; position:absolute; inset:-2px; border-radius:18px; pointer-events:none; opacity:0; }
  .bubble.sending{ background:var(--bubble-sending) !important; color:var(--bubble-strong-text); animation:pop .9s ease-in-out infinite; }
  .bubble.sending::after{ opacity:1; border:2px solid #ef4444; box-shadow:0 0 6px 2px rgba(239,68,68,.6); }
  .bubble.delivered{ background:var(--bubble-delivered) !important; color:var(--bubble-strong-text); animation:none; }
  .bubble.delivered::after{
    opacity:1; border:2px solid transparent;
    background:conic-gradient(#3b82f6,#f97316,#3b82f6) padding-box, conic-gradient(#3b82f6,#f97316,#3b82f6) border-box;
    mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor; mask-composite:exclude;
  }
  .bubble.seen{ background:var(--bubble-seen) !important; color:var(--bubble-strong-text); animation:none; }
  .bubble.seen::after{
    opacity:1; border:2px solid transparent;
    background:conic-gradient(#22c55e,#f97316,#3b82f6,#22c55e) padding-box, conic-gradient(#22c55e,#f97316,#3b82f6,#22c55e) border-box;
    mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor; mask-composite:exclude;
    animation:ringFade 2.2s ease both;
  }
  @keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
  @keyframes ringFade{0%,80%{opacity:1}100%{opacity:0}}

  .composerWrap{ position:fixed; left:0; right:0; bottom:10px; display:flex; justify-content:center; pointer-events:none; }
  .composer{
    pointer-events:auto; display:flex; flex-direction:column; gap:10px;
    background:var(--card); border-radius:16px; padding:10px; box-shadow:0 6px 18px rgba(0,0,0,.25);
    max-width:820px; width:calc(100% - 20px);
  }
  .previewBar{ display:none; align-items:center; gap:10px; border:1px dashed var(--divider); border-radius:12px; padding:8px; overflow:hidden; }
  .previewBar img{ max-height:80px; border-radius:10px }
  .waveCanvas{ width:100%; height:60px; background:rgba(59,130,246,.08); border-radius:10px }
  .controls{ display:flex; align-items:center; gap:8px; margin-left:auto }
  .icon{ background:none;border:none; cursor:pointer; padding:8px; border-radius:10px; display:grid; place-items:center; }
  .icon:hover{ background:rgba(0,0,0,.08) }
  @media (prefers-color-scheme: dark){ .icon:hover{ background:rgba(255,255,255,.08) } }
  .textRow{ display:flex; align-items:flex-end; gap:8px }
  .text{ flex:1; }
  .text textarea{ border:none; outline:none; padding:10px; border-radius:12px; width:100%; background:transparent; color:inherit; resize:none; min-height:40px; line-height:1.35; }
  .send{ background:#007bff; border:none; color:white; padding:10px; border-radius:12px; cursor:pointer; display:grid; place-items:center; width:44px; height:44px; opacity:.95; }
  .send:disabled{ opacity:.45; cursor:not-allowed; }

  /* Hide native file inputs fully */
  input[type=file]{ position:absolute !important; width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0,0,0,0) !important; white-space:nowrap !important; border:0 !important; opacity:0 !important; }

  /* Dummy picker */
  .dummyOverlay{ position:fixed; inset:0; z-index:20; display:none; align-items:center; justify-content:center; backdrop-filter: blur(6px); }
  .dummyCard{ background:var(--card); border:1px solid var(--divider); border-radius:16px; padding:16px; width:min(420px, 92vw); box-shadow:0 18px 40px rgba(0,0,0,.35); }
  .dummyBtn{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--divider); background:#fff; cursor:pointer; }
  @media (prefers-color-scheme: dark){ .dummyBtn{ background:#0f151d; color:#e7f0f7 } }

  /* Call modal */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:40; }
  .modal.show{ display:flex; }
  .modal .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.5); }
  .modal .panel{
    position:relative; background:var(--card); border:1px solid var(--divider); border-radius:16px; padding:16px;
    width:min(460px, 92vw); box-shadow:0 18px 40px rgba(0,0,0,.35);
  }
  video{ width:100%; border-radius:12px; background:#000; }
</style>
</head>
<body>
<div class="bg" aria-hidden="true"></div>

<header>
  <button class="back" id="backBtn" title="Chats">
    <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
  </button>

  <div class="chatHead">
    <div id="avatar" class="avatar">ðŸ™‚</div>
    <div class="titleWrap">
      <div id="chatTitle" class="title">Chat</div>
      <div id="chatSub" class="sub">LomyChat</div>
    </div>
  </div>

  <div class="ml-auto flex items-center gap-2">
    <button class="iconBtn" id="callBtn" title="Call" aria-label="Call">
      <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.84 19.84 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.84 19.84 0 0 1 2.08 4.18 2 2 0 0 1 4.06 2h3a2 2 0 0 1 2 1.72c.12.9.33 1.77.63 2.6a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.48-1.15a2 2 0 0 1 2.11-.45c.83.3 1.7.51 2.6.63A2 2 0 0 1 22 16.92z"/></svg>
    </button>
    <button id="viewProfileBtn" class="profileBtn" title="Open profile">Profile</button>
  </div>
</header>

<div class="app">
  <div id="msgs" class="msgs"></div>
</div>

<div class="composerWrap">
  <div class="composer">
    <div id="previewBar" class="previewBar" aria-live="polite">
      <img id="previewImg" alt=""/>
      <canvas id="waveCanvas" class="waveCanvas"></canvas>
      <div class="controls">
        <button id="previewCancel" class="icon" title="Remove" aria-label="Remove preview">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
        <button id="previewSend" class="icon" title="Send" aria-label="Send preview">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
      </div>
    </div>

    <div class="textRow">
      <button id="micBtn" class="icon" title="Record voice" aria-label="Record voice">
        <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 1 3 3v7a3 3 0 0 1-6 0V4a3 3 0 0 1 3-3z"/><path d="M19 10a7 7 0 0 1-14 0"/><path d="M12 19v4"/></svg>
      </button>
      <div class="text"><textarea id="msgInput" placeholder="Messageâ€¦" rows="1"></textarea></div>
      <button id="galleryBtn" class="icon" title="Gallery" aria-label="Gallery">
        <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
      </button>
      <button id="cameraBtn" class="icon" title="Camera" aria-label="Camera">
        <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
      </button>
      <button id="sendBtn" class="send" title="Send" aria-label="Send" disabled>
        <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
      </button>
    </div>
  </div>
</div>

<input id="galleryInput" type="file" accept="image/*"/>
<input id="cameraInput" type="file" accept="image/*" capture="environment"/>

<div id="dummyOverlay" class="dummyOverlay">
  <div class="dummyCard">
    <h3 class="text-lg font-bold mb-1">Pick a test chat</h3>
    <p class="text-sm opacity-80 mb-3">This only shows if no real chat is selected.</p>
    <div class="grid gap-2">
      <button class="dummyBtn" data-uid="dummy1" data-cid="conv_dummy1">Chat with Dummy One</button>
      <button class="dummyBtn" data-uid="dummy2" data-cid="conv_dummy2">Chat with Dummy Two</button>
      <button class="dummyBtn" data-uid="dummy3" data-cid="conv_dummy3">Chat with Dummy Three</button>
    </div>
  </div>
</div>

<!-- Call modal -->
<div id="callModal" class="modal" aria-hidden="true">
  <div class="backdrop" id="callBackdrop"></div>
  <div class="panel">
    <h3 class="font-bold text-lg mb-2">Call</h3>
    <p id="callWho" class="text-sm opacity-80 mb-3">Ready</p>
    <div class="grid gap-2 mb-3">
      <video id="selfVideo" autoplay playsinline muted></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
    <div class="flex gap-3">
      <button id="startAudio" class="px-4 py-2 rounded-md bg-blue-600 text-white">Audio</button>
      <button id="startVideo" class="px-4 py-2 rounded-md bg-green-600 text-white">Video</button>
      <button id="hangup" class="ml-auto px-4 py-2 rounded-md bg-rose-600 text-white">Hang up</button>
    </div>
  </div>
</div>

<script type="module">
  import { auth } from './firebase.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import {
    getFirestore, doc, collection, getDoc, setDoc, addDoc,
    onSnapshot, orderBy, query, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

  const app = getApp();
  const db = getFirestore(app);
  const storage = getStorage(app);

  const $ = s => document.querySelector(s);
  const msgsEl = $("#msgs");
  const msgInput = $("#msgInput");
  const sendBtn = $("#sendBtn");
  const backBtn = $("#backBtn");
  const viewProfileBtn = $("#viewProfileBtn");
  const micBtn = $("#micBtn");
  const galleryBtn = $("#galleryBtn");
  const cameraBtn = $("#cameraBtn");
  const galleryInput = $("#galleryInput");
  const cameraInput = $("#cameraInput");
  const previewBar = $("#previewBar");
  const previewImg = $("#previewImg");
  const waveCanvas = $("#waveCanvas");
  const previewCancel = $("#previewCancel");
  const previewSend = $("#previewSend");
  const dummyOverlay = $("#dummyOverlay");

  // Call
  const callBtn = $("#callBtn");
  const callModal = $("#callModal");
  const callBackdrop = $("#callBackdrop");
  const startAudioBtn = $("#startAudio");
  const startVideoBtn = $("#startVideo");
  const hangupBtn = $("#hangup");
  const selfVideo = $("#selfVideo");
  const remoteVideo = $("#remoteVideo");
  const callWho = $("#callWho");

  // Real or dummy
  const qp = new URLSearchParams(location.search);
  let CONV_ID = qp.get('c') || '';
  let OTHER_UID = qp.get('u') || '';
  let IS_DUMMY = false;

  if(!CONV_ID || !OTHER_UID){
    IS_DUMMY = true;
    dummyOverlay.style.display = 'flex';
    dummyOverlay.querySelectorAll('.dummyBtn').forEach(btn=>{
      btn.onclick = ()=>{
        CONV_ID = btn.dataset.cid;
        OTHER_UID = btn.dataset.uid;
        IS_DUMMY = true; // remains dummy test chat
        dummyOverlay.style.display = 'none';
        startApp();
      };
    });
  }

  backBtn.onclick = ()=> location.href = 'chatlist.html';

  // Open profile-other.html for current chat user
  viewProfileBtn.onclick = ()=>{
    if(!OTHER_UID) return;
    // For real users: opens that person's profile. For dummy: also opens but with dummy id.
    location.href = `profile-other.html?uid=${encodeURIComponent(OTHER_UID)}`;
  };

  let me = null;
  onAuthStateChanged(auth, (user)=>{
    // Fallback tester account allows testing without login
    me = user || { uid:'tester', email:'tester@example.com' };
    if(CONV_ID && OTHER_UID){ startApp(); }
    else if(dummyOverlay.style.display==='none'){ dummyOverlay.style.display='flex'; }
  });

  // Stream messages
  let unsubscribe = null;
  async function startApp(){
    // Set header name/avatar; never shows "dummy" text in header
    try{
      const o = await getDoc(doc(db,'users', OTHER_UID));
      const data = o.exists()? o.data() : {};
      document.getElementById('chatTitle').textContent = data.username || OTHER_UID;
      document.getElementById('avatar').textContent = data.avatarEmoji || 'ðŸ‘¤';
    }catch{
      document.getElementById('chatTitle').textContent = OTHER_UID;
      document.getElementById('avatar').textContent = 'ðŸ‘¤';
    }

    if(unsubscribe) unsubscribe();
    const q = query(collection(db,'conversations',CONV_ID,'messages'), orderBy('createdAt','asc'));
    unsubscribe = onSnapshot(q, (snap)=>{
      let html = '';
      snap.forEach(d=>{
        const m = d.data();
        const mine = m.from === me.uid;
        html += bubbleHTML(d.id, m, mine);
      });
      msgsEl.innerHTML = html;
      scrollToBottom();
    });
  }

  function scrollToBottom(){ msgsEl.scrollTop = msgsEl.scrollHeight; }
  function fmtTime(ts){
    const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date());
    const hh = d.getHours().toString().padStart(2,'0'), mm = d.getMinutes().toString().padStart(2,'0');
    return `${hh}:${mm}`;
  }
  function safe(s){ return (s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function statusClass(s){ return s==='sending'?'sending':s==='delivered'?'delivered':s==='seen'?'seen':''; }

  function bubbleHTML(id, m, isMe){
    const st = statusClass(m.status);
    const time = fmtTime(m.createdAt);
    if(m.type === 'image'){
      // Images are stored and shared via a public link so the other user can see them
      const img = m.content ? `<img src="${m.content}" alt="photo" onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';">` : `<div class="text-xs opacity-80">Uploading photoâ€¦</div>`;
      return `<div class="row ${isMe?'me':''}" data-id="${id}"><div class="bubble ${st}">${img}<span class="time">${time||''}</span></div></div>`;
    }
    if(m.type === 'audio'){
      // Simple player: the other user can open/play the voice note via the link
      const aud = m.content ? `<audio controls src="${m.content}"></audio>` : `<div class="text-xs opacity-80">Processing voice noteâ€¦</div>`;
      return `<div class="row ${isMe?'me':''}" data-id="${id}"><div class="bubble ${st}">${aud}<span class="time">${time||''}</span></div></div>`;
    }
    return `<div class="row ${isMe?'me':''}" data-id="${id}"><div class="bubble ${st}">${safe(m.content||'')}<span class="time">${time||''}${m.edited?' Â· edited':''}</span></div></div>`;
  }

  // Text send
  function updateSendEnabled(){ sendBtn.disabled = !((msgInput.value||'').trim().length > 0); }
  function autoResize(){ msgInput.style.height='auto'; msgInput.style.height=Math.min(msgInput.scrollHeight, 140)+'px'; }
  msgInput.addEventListener('input', ()=>{ autoResize(); updateSendEnabled(); });
  msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); }});
  sendBtn.onclick = ()=> sendText();
  autoResize(); updateSendEnabled();

  async function sendText(){
    const text = (msgInput.value||'').trim();
    if(!text) return;
    if(!CONV_ID || !OTHER_UID){ alert('Pick a chat first.'); return; }
    try{
      const now = serverTimestamp();
      const cref = doc(db,'conversations',CONV_ID);
      const mref = collection(db,'conversations',CONV_ID,'messages');
      const added = await addDoc(mref, { type:'text', content:text, from: me.uid, to: OTHER_UID, status:'sending', createdAt: now, edited:false });
      await setDoc(added, { status:'delivered' }, { merge:true });
      await setDoc(cref, { lastMessage:text, updatedAt: now, members:[me.uid, OTHER_UID] }, { merge:true });
      msgInput.value=''; autoResize(); updateSendEnabled(); scrollToBottom();
    }catch(e){ alert('Send failed: ' + e.message); }
  }
  
  
  // Media preview
  function showImagePreview(file){
    previewImg.src = URL.createObjectURL(file);
    previewImg.style.display = 'block';
    waveCanvas.style.display = 'none';
    previewBar.style.display = 'flex';
    previewBar.dataset.type = 'image';
    previewBar._file = file;
  }
  function showWavePreview(){
    previewImg.style.display='none';
    waveCanvas.style.display='block';
    previewBar.style.display='flex';
    previewBar.dataset.type='audio';
  }
  function clearPreview(){
    previewBar.style.display = 'none';
    previewBar.dataset.type = '';
    previewBar._file = null;
    previewImg.src = '';
    stopVisualizer();
    _pendingAudioBlob=null;
    autoSendAfterStop=false;
  }
  $("#previewCancel").onclick = clearPreview;

  $("#galleryBtn").onclick = ()=> $("#galleryInput").click();
  $("#cameraBtn").onclick = ()=> $("#cameraInput").click();
  $("#galleryInput").onchange = ()=> { const f = $("#galleryInput").files?.[0]; if(f){ showImagePreview(f); $("#galleryInput").value=''; } };
  $("#cameraInput").onchange = ()=> { const f = $("#cameraInput").files?.[0]; if(f){ showImagePreview(f); $("#cameraInput").value=''; } };

  // Uploads
  async function uploadImage(file){
    if(!CONV_ID || !OTHER_UID){ alert('Pick a chat first.'); return; }
    const now = serverTimestamp();
    const cref = doc(db,'conversations',CONV_ID);
    const mref = collection(db,'conversations',CONV_ID,'messages');
    const pending = await addDoc(mref, { type:'image', content:'', from:me.uid, to:OTHER_UID, createdAt: now, status:'sending' });
    try{
      const path = `conversations/${CONV_ID}/images/${Date.now()}_${me.uid}_${file.name}`;
      const r = sRef(storage, path);
      await uploadBytes(r, file);
      const url = await getDownloadURL(r); // public URL so other user can see
      await setDoc(pending, { content:url, status:'delivered' }, { merge:true });
      await setDoc(cref, { lastMessage:'[Photo]', updatedAt: now, members:[me.uid, OTHER_UID] }, { merge:true });
      scrollToBottom();
    }catch(e){ alert('Image upload failed: ' + e.message); }
  }
  async function uploadAudio(blob){
    if(!CONV_ID || !OTHER_UID){ alert('Pick a chat first.'); return; }
    const now = serverTimestamp();
    const cref = doc(db,'conversations',CONV_ID);
    const mref = collection(db,'conversations',CONV_ID,'messages');
    const pending = await addDoc(mref, { type:'audio', content:'', from:me.uid, to:OTHER_UID, createdAt: now, status:'sending' });
    try{
      const path = `conversations/${CONV_ID}/audio/${Date.now()}_${me.uid}.webm`;
      const r = sRef(storage, path);
      await uploadBytes(r, blob);
      const url = await getDownloadURL(r); // public URL so other user can play
      await setDoc(pending, { content:url, status:'delivered' }, { merge:true });
      await setDoc(cref, { lastMessage:'[Voice note]', updatedAt: now, members:[me.uid, OTHER_UID] }, { merge:true });
      scrollToBottom();
    }catch(e){ alert('Audio upload failed: ' + e.message); }
  }

  // Preview send button
  $("#previewSend").onclick = async ()=>{
    const t = previewBar.dataset.type;
    if(t==='image' && previewBar._file){
      await uploadImage(previewBar._file);
      clearPreview();
    }else if(t==='audio'){
      if(mediaRecorder && mediaRecorder.state==='recording'){
        autoSendAfterStop = true;
        mediaRecorder.stop();
      }else if(_pendingAudioBlob){
        await uploadAudio(_pendingAudioBlob);
        clearPreview();
      }
    }
  };

  // Recording + visualizer
  let recStream=null, mediaRecorder=null, recChunks=[];
  let audioCtx=null, analyser=null, rafId=null;
  let _pendingAudioBlob=null; let autoSendAfterStop=false;

  $("#micBtn").onclick = async ()=>{
    if(mediaRecorder && mediaRecorder.state==='recording'){ mediaRecorder.stop(); return; }
    try{
      recStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      recChunks = []; mediaRecorder = new MediaRecorder(recStream);
      showWavePreview(); startVisualizer(recStream);
      mediaRecorder.ondataavailable = e=>{ if(e.data.size>0) recChunks.push(e.data); };
      mediaRecorder.onstop = async ()=>{
        recStream.getTracks().forEach(t=>t.stop());
        _pendingAudioBlob = new Blob(recChunks, { type:'audio/webm' });
        stopVisualizer(true);
        if(autoSendAfterStop && _pendingAudioBlob){
          await uploadAudio(_pendingAudioBlob);
          clearPreview();
        }
      };
      mediaRecorder.start();
    }catch(e){
      alert('Microphone error: '+e.message+(location.protocol!=='https:'?'\nTip: Use HTTPS for mic.':''));
      clearPreview();
    }
  };

  function startVisualizer(stream){
    stopVisualizer();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const cssW = waveCanvas.clientWidth || 600;
    const cssH = waveCanvas.clientHeight || 60;
    waveCanvas.width = Math.floor(cssW * dpr);
    waveCanvas.height = Math.floor(cssH * dpr);
    const ctx = waveCanvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 512;
    source.connect(analyser);

    const buffer = new Uint8Array(analyser.fftSize);
    function draw(){
      rafId = requestAnimationFrame(draw);
      analyser.getByteTimeDomainData(buffer);
      const W = cssW, H = cssH;
      ctx.clearRect(0,0,W,H);
      const bars = 32, step = Math.floor(buffer.length/bars);
      for(let i=0;i<bars;i++){
        let sum=0; for(let j=0;j<step;j++){ const v = buffer[i*step+j]-128; sum+=Math.abs(v); }
        const avg = sum/step, h = Math.max(6, (avg/128)*(H-8));
        const x = (W/bars)*i+3, y = H-h-4, w = (W/bars)-6;
        ctx.fillStyle='#60a5fa'; ctx.fillRect(x,y,w,h);
        ctx.fillStyle='#3b82f6'; ctx.fillRect(x,y,w,4);
      }
    }
    draw();
  }
  function stopVisualizer(keepFrame=false){
    if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
    if(!keepFrame){
      const c = waveCanvas.getContext?.('2d'); if(c){ c.clearRect(0,0,waveCanvas.width,waveCanvas.height); }
    }
    if(audioCtx){ try{ audioCtx.close(); }catch{} audioCtx=null; }
    analyser=null;
  }

  // Calls: open modal, preview audio/video, hang up
  let callLocalStream=null, callRemoteStream=null;
  callBtn.onclick = ()=>{
    const who = document.getElementById('chatTitle')?.textContent || 'User';
    callWho.textContent = `Calling ${who}`;
    callModal.classList.add('show');
  };
  callBackdrop.onclick = endCall;
  hangupBtn.onclick = endCall;
  startAudioBtn.onclick = ()=> startLocal({ audio:true, video:false });
  startVideoBtn.onclick = ()=> startLocal({ audio:true, video:true });

  async function startLocal(constraints){
    try{
      if(callLocalStream) stopStream(callLocalStream);
      callLocalStream = await navigator.mediaDevices.getUserMedia(constraints);
      selfVideo.srcObject = callLocalStream;

      // Simple local mirror demo (so you can see both panes)
      if(callRemoteStream) stopStream(callRemoteStream);
      callRemoteStream = new MediaStream();
      callLocalStream.getTracks().forEach(t=>{
        try{ callRemoteStream.addTrack(t.clone()); }catch{ callRemoteStream.addTrack(t); }
      });
      remoteVideo.srcObject = callRemoteStream;
    }catch(e){
      alert('Call error: '+e.message+(location.protocol!=='https:'?'\nTip: Use HTTPS and allow mic/camera.':''));
    }
  }
  function endCall(){
    callModal.classList.remove('show');
    if(callLocalStream) stopStream(callLocalStream);
    if(callRemoteStream) stopStream(callRemoteStream);
    selfVideo.srcObject = null; remoteVideo.srcObject = null;
  }
  function stopStream(s){ s.getTracks().forEach(t=>t.stop()); }
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972389cf525188ef',t:'MTc1NTcxMDE4NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
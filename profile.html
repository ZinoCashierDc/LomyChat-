<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LomyChat — My Profile</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<!-- Firebase Libraries -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js" type="module"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js" type="module"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js" type="module"></script>
<style>
  :root{ --card:#ffffff; --text:#0b1220; --muted:#667085; --divider:#e6eaf0; --brand:#0ea5e9; --glass: rgba(255,255,255,.5); --glass-border: rgba(15,23,42,.08); }
  @media (prefers-color-scheme: dark){ :root{ --card:#0b121a; --text:#e7f0f7; --muted:#9db4c7; --divider:#1b2633; --glass: rgba(15,23,42,.45); --glass-border: rgba(255,255,255,.08); } }
  body{ margin:0; color:var(--text); font:15px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Inter, Arial, sans-serif; overflow:hidden; }
  .bg{ position:fixed; inset:0; z-index:-1; background-size:cover; background-position:center; }
  @media (prefers-color-scheme: light){ .bg{ background-image:url('https://i.postimg.cc/Y0Wb7Vfc/IMG-20250816-WA0070.jpg'); } }
  @media (prefers-color-scheme: dark){ .bg{ background-image:url('https://i.postimg.cc/QCT9nq8d/IMG-20250816-WA0069.jpg'); } }
  .glass{ background:var(--glass); backdrop-filter: blur(12px); border:1px solid var(--glass-border); border-radius: 16px; }
  .ring-outer{ background: conic-gradient(#60a5fa,#22c55e,#f59e0b,#60a5fa); padding:3px; border-radius:9999px; }
  .field{ background:var(--card); border:1px solid var(--divider); border-radius:12px; }
  .qrCard{ background:var(--card); border:1px solid var(--divider); border-radius:14px; }
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:40; }
  .modal.show{ display:flex; }
  #toast{ display:none; }
</style>
</head>
<body>
<div class="bg"></div>

<header class="glass sticky top-0 z-10 mx-2 mt-2">
  <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
    <button id="backBtn" class="w-10 h-10 rounded-xl bg-white/20 hover:bg-white/30 text-white grid place-items-center" title="Back">←</button>
    <a href="chatlist.html" class="ml-auto px-3 py-2 rounded-lg bg-white/20 hover:bg-white/30 text-white font-semibold">Back to Chats</a>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 overflow-auto h-[calc(100vh-80px)]">
  <section class="grid lg:grid-cols-[340px_1fr] gap-6 items-start">
    <div class="glass rounded-2xl p-5">
      <div class="grid justify-items-center gap-4">
        <div class="ring-outer"><img id="avatarImg" class="w-40 h-40 rounded-full bg-white/10 object-cover" /></div>
        <div class="text-center">
          <h1 id="displayName" class="text-2xl font-extrabold text-white">Loading...</h1>
          <p id="usernameDisplay" class="text-sm text-white/80">$username</p>
        </div>
        <div class="w-full grid grid-cols-2 gap-3">
          <button id="editBtn" class="px-3 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-white font-semibold">Edit</button>
          <button id="shareBtn" class="px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-semibold">Share</button>
        </div>
        <div class="w-full grid grid-cols-2 gap-3">
          <button id="qrBtn" class="px-3 py-2 rounded-xl bg-white/20 hover:bg-white/30 text-white font-semibold">My QR Code</button>
          <button id="signOutBtn" class="px-3 py-2 rounded-xl bg-rose-500/50 hover:bg-rose-500/70 text-white font-semibold">Sign Out</button>
        </div>
      </div>
    </div>
    <div class="rounded-2xl p-5 bg-[var(--card)] border border-[var(--divider)]">
      <div class="grid md:grid-cols-2 gap-5">
        <div class="grid gap-3">
          <label class="text-sm font-semibold text-[var(--muted)]">Display Name</label>
          <input id="nameInput" class="field px-3 py-2 disabled:opacity-70" placeholder="Your name" disabled/>
          <label class="text-sm font-semibold text-[var(--muted)]">Username <span class="text-xs">(must start with $)</span></label>
          <input id="usernameInput" class="field px-3 py-2 disabled:opacity-70" placeholder="$username" disabled/>
          <label class="text-sm font-semibold text-[var(--muted)]">Bio</label>
          <textarea id="bioInput" class="field px-3 py-2 disabled:opacity-70" rows="4" placeholder="Tell people about yourself" disabled></textarea>
          <div id="editControls" class="flex gap-3 mt-2 hidden">
            <button id="saveBtn" class="px-4 py-2 rounded-xl bg-sky-600 hover:bg-sky-700 text-white font-semibold">Save Changes</button>
            <button id="cancelBtn" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-600 dark:text-white font-semibold">Cancel</button>
          </div>
        </div>
        <div class="qrCard p-4 text-center">
          <h3 class="font-bold text-[var(--text)] mb-2">Your Public Profile Link</h3>
          <canvas id="qrCode" class="w-40 h-40 mx-auto rounded-lg"></canvas>
          <p class="text-xs text-[var(--muted)] mt-2">Others can scan this to view your profile.</p>
          <button id="copyLinkBtn" class="mt-3 w-full px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 font-semibold">Copy Link</button>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="qrModal" class="modal bg-black/60">
  <div class="relative w-[min(420px,92vw)] rounded-2xl bg-[var(--card)] border border-[var(--divider)] p-5 shadow-2xl">
    <div class="flex items-center mb-3"><h3 class="font-bold text-lg">My QR Code</h3><button id="qrClose" class="ml-auto font-bold text-2xl">&times;</button></div>
    <canvas id="qrCanvasBig" class="w-full max-w-xs aspect-square mx-auto rounded-lg"></canvas>
  </div>
</div>
<div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl text-sm shadow-lg"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAW6rJOip8zSZ4dUrU5NroTOVDju4gdTh0",
    authDomain: "lomychat.firebaseapp.com",
    projectId: "lomychat",
    storageBucket: "lomychat.firebasestorage.app",
    messagingSenderId: "556633248856",
    appId: "1:556633248856:web:fd93d8fe7a825c2cd0a62d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let userProfile = {};

  // All DOM element selections are moved inside the main function
  // to ensure they exist before we use them.
  function initializeProfilePage() {
    const $ = s => document.querySelector(s);
    const backBtn = $("#backBtn");
    const displayNameEl = $("#displayName"), usernameDisplay = $("#usernameDisplay");
    const nameInput = $("#nameInput"), usernameInput = $("#usernameInput"), bioInput = $("#bioInput");
    const editBtn = $("#editBtn"), saveBtn = $("#saveBtn"), cancelBtn = $("#cancelBtn");
    const editControls = $("#editControls");
    const signOutBtn = $("#signOutBtn"), shareBtn = $("#shareBtn"), copyLinkBtn = $("#copyLinkBtn");
    const qrBtn = $("#qrBtn"), qrModal = $("#qrModal"), qrClose = $("#qrClose");

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        loadUserProfile();
      } else {
        window.location.href = 'index.html';
      }
    });

    async function loadUserProfile() {
      const userRef = doc(db, "users", currentUser.uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        userProfile = userSnap.data();
      }
      renderProfile();
    }

    function renderProfile() {
      displayNameEl.textContent = userProfile.displayName || 'Set Your Name';
      usernameDisplay.textContent = userProfile.username || '$username';
      nameInput.value = userProfile.displayName || '';
      usernameInput.value = userProfile.username || '';
      bioInput.value = userProfile.bio || '';
      
      const profileLink = new URL(`profile-other.html?uid=${currentUser.uid}`, window.location.href).href;
      QRCode.toCanvas($("#qrCode"), profileLink, { width: 160, margin: 1 });
      QRCode.toCanvas($("#qrCanvasBig"), profileLink, { width: 400, margin: 1 });
    }

    async function saveProfile() {
      const newUsername = usernameInput.value.trim();
      if (!newUsername.startsWith('$') || newUsername.length < 3) {
        showToast("Username must start with $ and be at least 2 characters long.");
        return;
      }
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const newUsernameLower = newUsername.toLowerCase();
        if (newUsernameLower !== (userProfile.username_lowercase || '')) {
          const q = query(collection(db, "users"), where("username_lowercase", "==", newUsernameLower));
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            showToast("This username is already taken.");
            return;
          }
        }
        
        const userRef = doc(db, "users", currentUser.uid);
        const profileData = {
          displayName: nameInput.value.trim(),
          username: newUsername,
          username_lowercase: newUsernameLower,
          bio: bioInput.value.trim(),
          updatedAt: serverTimestamp()
        };
        
        await setDoc(userRef, profileData, { merge: true });
        userProfile = { ...userProfile, ...profileData };
        renderProfile();
        toggleEditMode(false);
        showToast("Profile saved successfully!", true);

      } catch (error) {
        console.error("Error saving:", error);
        showToast("Failed to save profile.");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    }

    function toggleEditMode(isEditing) {
      nameInput.disabled = !isEditing;
      usernameInput.disabled = !isEditing;
      bioInput.disabled = !isEditing;
      editControls.classList.toggle('hidden', !isEditing);
      editBtn.classList.toggle('hidden', isEditing);
    }

    // --- All Event Listeners are now guaranteed to work ---
    backBtn.onclick = () => history.back();
    editBtn.onclick = () => toggleEditMode(true);
    cancelBtn.onclick = () => { renderProfile(); toggleEditMode(false); };
    saveBtn.onclick = saveProfile;
    signOutBtn.onclick = async () => { await signOut(auth); window.location.href = 'index.html'; };
    qrBtn.onclick = () => qrModal.classList.add('show');
    qrClose.onclick = () => qrModal.classList.remove('show');
    
    const shareOrCopy = async (isShare) => {
      const profileLink = new URL(`profile-other.html?uid=${currentUser.uid}`, window.location.href).href;
      try {
        await navigator.clipboard.writeText(profileLink);
        showToast("Profile link copied!", true);
      } catch (err) {
        showToast('Action failed.');
      }
    };
    shareBtn.onclick = () => shareOrCopy(true); // Simplified to copy for now
    copyLinkBtn.onclick = () => shareOrCopy(false);
  }

  function showToast(msg, isSuccess = false) {
    const toast = document.querySelector("#toast");
    toast.textContent = msg;
    toast.className = `fixed bottom-4 left-1/2 -translate-x-1-2 px-4 py-2 rounded-xl text-white text-sm shadow-lg ${isSuccess ? 'bg-green-600' : 'bg-red-600'}`;
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 3000);
  }

  // Start the page logic
  initializeProfilePage();
</script>
</body>
</html>
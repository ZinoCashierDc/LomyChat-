<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LomyChat ‚Äî My Profile</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
  :root{
    --card:#ffffff;
    --text:#0b1220;
    --muted:#667085;
    --divider:#e6eaf0;
    --brand:#0ea5e9;  /* cyan */
    --brand2:#22c55e; /* green */
    --bg1:#f5f9ff;
    --bg2:#eefcf5;
    --glass: rgba(255,255,255,.5);
    --glass-border: rgba(15,23,42,.08);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --card:#0b121a;
      --text:#e7f0f7;
      --muted:#9db4c7;
      --divider:#1b2633;
      --bg1:#0b1220; /* deep night */
      --bg2:#0f1a29; /* subtle blue tint */
      --glass: rgba(15,23,42,.45);
      --glass-border: rgba(255,255,255,.08);
    }
  }

  html,body{height:100%}
body{
  margin:0; 
  color:var(--text);
  font:15px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial;
  overflow:hidden;
}

/* Background that switches automatically (light/dark mode) */
.bg{
  position:fixed;
  inset:0;
  z-index:-1;
  background-size:cover;
  background-position:center;
}

/* Light mode background */
@media (prefers-color-scheme: light){
  .bg{
    background-image:url('https://i.postimg.cc/Y0Wb7Vfc/IMG-20250816-WA0070.jpg');
  }
}

/* Dark mode background */
@media (prefers-color-scheme: dark){
  .bg{
    background-image:url('https://i.postimg.cc/QCT9nq8d/IMG-20250816-WA0069.jpg');
  }
}

/* Glass overlay */
.glass{ 
  background:var(--bg-overlay); 
  backdrop-filter: blur(12px); 
  border:1px solid var(--glass-border); 
  border-radius: 12px; 
}

.ring-outer{ 
  background: conic-gradient(#60a5fa,#22c55e,#f59e0b,#60a5fa); 
  padding:3px; 
  border-radius:9999px; 
}

.field{ 
  background:var(--card); 
  border:1px solid var(--divider); 
  border-radius:12px; 
}

.qrCard{ 
  background:var(--card); 
  border:1px solid var(--divider); 
  border-radius:14px; 
}

.modal{ 
  position:fixed; 
  inset:0; 
  display:none; 
  align-items:center; 
  justify-content:center; 
  z-index:40; 
}
.modal.show{ display:flex; }

  /* Toast */
  #toast{ display:none; }
</style>
</head>
<body>
<div class="bg"></div>

<header class="glass sticky top-0 z-10">
  <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
    <button id="backBtn" class="w-10 h-10 rounded-xl bg-white/20 hover:bg-white/30 text-white grid place-items-center" title="Back">
      ‚Üê
      </button>

    <div class="flex items-center gap-2">
      <div class="w-8 h-8 rounded-lg grid place-items-center">
        <!-- Clean logo mark -->
        <img
          class="logo-behind w-12 sm:w-14 md:w-16"
          src="https://i.postimg.cc/d0Vh4kXD/-removebg-preview.png"
          alt="LomyChat Logo"
          width="96"
          height="96"
        />
      </div>

    <div class="ml-auto flex items-center gap-2">
      <a id="toListBtn" href="chatlist.html" class="px-3 py-2 rounded-lg bg-white/20 hover:bg-white/30 text-white font-semibold">Back to Chats</a>
    </div>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 overflow-auto h-[calc(100vh-64px)]">
  <section class="grid lg:grid-cols-[340px_1fr] gap-6 items-start">
    <!-- Left: Avatar + main actions -->
    <div class="glass rounded-2xl p-5">
      <div class="grid justify-items-center gap-4">
        <div class="ring-outer">
          <div id="avatarCircle" class="w-40 h-40 rounded-full bg-white/10 grid place-items-center text-6xl select-none">üôÇ</div>
        </div>
        <div class="text-center">
          <h1 id="displayName" class="text-2xl font-extrabold text-white">My Name</h1>
          <p id="usernameDisplay" class="text-sm text-white/80">$username</p>
        </div>

        <div class="w-full grid grid-cols-2 gap-3">
          <button id="editBtn" class="px-3 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-white font-semibold">Edit</button>
          <button id="shareBtn" class="px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-semibold">Share</button>
        </div>

        <div class="w-full grid grid-cols-3 gap-3">
          <button id="qrBtn" class="px-3 py-2 rounded-xl bg-white/20 hover:bg-white/30 text-white font-semibold">My QR</button>
          <a id="openChatsBtn" href="chatlist.html" class="px-3 py-2 rounded-xl bg-white/20 hover:bg-white/30 text-white font-semibold text-center">Chats</a>
          <button id="signOutBtn" class="px-3 py-2 rounded-xl bg-white/20 hover:bg-white/30 text-white font-semibold">Sign out</button>
        </div>
      </div>
    </div>

    <!-- Right: Editable fields + QR -->
    <div class="rounded-2xl p-5 bg-[var(--card)] border border-[var(--divider)]">
      <div class="grid md:grid-cols-2 gap-5">
        <div class="grid gap-3">
          <label class="text-sm font-semibold text-[var(--muted)]">Display name</label>
          <input id="nameInput" class="field px-3 py-2" placeholder="Your name"/>

          <label class="text-sm font-semibold text-[var(--muted)]">Username (starts with $)</label>
          <div class="flex gap-2 items-center">
            <input id="usernameInput" class="field flex-1 px-3 py-2" placeholder="$username"/>
          </div>

          <label class="text-sm font-semibold text-[var(--muted)]">Bio</label>
          <textarea id="bioInput" class="field px-3 py-2" rows="4" placeholder="Tell people a bit about you"></textarea>

          <div class="flex gap-3 mt-2">
            <button id="saveBtn" class="px-4 py-2 rounded-xl bg-sky-600 hover:bg-sky-700 text-white font-semibold">Save</button>
            <button id="cancelBtn" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold">Cancel</button>
            <button id="emojiBtn" class="ml-auto px-4 py-2 rounded-xl bg-amber-400 hover:bg-amber-500 text-white font-semibold">Pick emoji</button>
          </div>
        </div>

        <div class="qrCard p-4">
          <div class="font-bold text-[var(--text)] mb-2">Your QR</div>
          <canvas id="qrCode" class="w-40 h-40 mx-auto"></canvas>
          <div class="text-xs text-[var(--muted)] mt-2 text-center">Scan to view your profile</div>
          <button id="copyLinkBtn" class="mt-3 w-full px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold">Copy profile link</button>
        </div>
      </div>

      <div class="mt-6 text-sm text-[var(--muted)]">
        Tip: Long messages are fully supported in chat. Bubbles expand naturally and wrap neatly.
      </div>
    </div>
  </section>
</main>

<!-- QR Modal -->
<div id="qrModal" class="modal">
  <div class="absolute inset-0 bg-black/60" id="qrBackdrop"></div>
  <div class="relative w-[min(420px,92vw)] rounded-2xl bg-[var(--card)] border border-[var(--divider)] p-5 shadow-2xl">
    <div class="flex items-center gap-3 mb-3">
      <div class="w-9 h-9 rounded-lg bg-sky-500 grid place-items-center">
        <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 7h3M14 7h3M7 14h3M14 14h3"/></svg>
      </div>
      <div class="font-bold text-[var(--text)]">My QR</div>
      <button id="qrClose" class="ml-auto px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold">Close</button>
    </div>
    <div class="grid place-items-center">
      <canvas id="qrCanvasBig" class="w-56 h-56"></canvas>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-xl text-sm shadow" style="display:none;"></div>

<script type="module">
  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAW6rJOip8zSZ4dUrU5NroTOVDju4gdTh0",
    authDomain: "lomychat.firebaseapp.com",
    projectId: "lomychat",
    storageBucket: "lomychat.firebasestorage.app",
    messagingSenderId: "556633248856",
    appId: "1:556633248856:web:fd93d8fe7a825c2cd0a62d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // DOM
  const $ = s => document.querySelector(s);
  const toast = $("#toast");

  function showToast(msg, ok=false){
    toast.textContent = msg;
    toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-xl text-sm shadow ${ok?'bg-green-600 text-white':'bg-rose-600 text-white'}`;
    toast.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display='none', 2400);
  }

  // Back nav context from query
  const qp = new URLSearchParams(location.search);
  const backConv = qp.get('c') || '';
  const backUser = qp.get('u') || '';

  // Elements
  const backBtn = $("#backBtn");
  const avatarCircle = $("#avatarCircle");
  const displayNameEl = $("#displayName");
  const usernameDisplay = $("#usernameDisplay");
  const nameInput = $("#nameInput");
  const usernameInput = $("#usernameInput");
  const bioInput = $("#bioInput");
  const editBtn = $("#editBtn");
  const saveBtn = $("#saveBtn");
  const cancelBtn = $("#cancelBtn");
  const emojiBtn = $("#emojiBtn");
  const shareBtn = $("#shareBtn");
  const copyLinkBtn = $("#copyLinkBtn");
  const qrBtn = $("#qrBtn");
  const qrCanvas = $("#qrCode");
  const qrModal = $("#qrModal");
  const qrBackdrop = $("#qrBackdrop");
  const qrClose = $("#qrClose");
  const qrCanvasBig = $("#qrCanvasBig");
  const openChatsBtn = $("#openChatsBtn");
  const signOutBtn = $("#signOutBtn");

  // State
  let currentUser = null;
  let editing = false;
  let profile = { username:"", usernameLower:"", bio:"", emoji:null, displayName:"", photoURL:"" };

  // Initials helper
  function initialsFrom(usernameOrEmail){
    const raw = (usernameOrEmail||'').replace(/^\$/,'').trim();
    if(!raw) return "??";
    const parts = raw.split(/[^a-z0-9]+/i).filter(Boolean);
    const A = parts[0]?.[0] || raw[0] || '?';
    const B = parts[1]?.[0] || raw[1] || '';
    return (A + B).toUpperCase();
  }

  function render(){
    // Avatar: emoji or initials
    avatarCircle.textContent = profile.emoji || initialsFrom(profile.username || currentUser?.email || "?");
    // Top text
    displayNameEl.textContent = profile.displayName || profile.username || (currentUser?.email || 'Me');
    usernameDisplay.textContent = profile.username || '$username';
    // Inputs
    nameInput.value = profile.displayName || profile.username || '';
    usernameInput.value = profile.username || '';
    bioInput.value = profile.bio || '';
    // QR code: points to profile.html?u=<username>
    const deepLink = `${location.origin}${location.pathname}?u=${encodeURIComponent(profile.username || '')}`;
    QRCode.toCanvas(qrCanvas, deepLink || "lomychat://profile", { width: 200, margin: 1 }, (err)=>{ if(err) console.error(err); });
    QRCode.toCanvas(qrCanvasBig, deepLink || "lomychat://profile", { width: 280, margin: 1 }, (err)=>{ if(err) console.error(err); });
  }

  async function loadProfile(uid){
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if (snap.exists()){
      const data = snap.data();
      profile.username = data.username || "";
      profile.usernameLower = data.usernameLower || (data.username || "").toLowerCase();
      profile.bio = data.bio || "";
      profile.emoji = data.emoji || null;
      profile.displayName = data.displayName || data.username || "";
      profile.photoURL = data.photoURL || "";
    }else{
      await setDoc(ref, { uid, createdAt: serverTimestamp(), lastSeen: serverTimestamp() }, { merge:true });
    }
    render();
  }

  async function saveBio(newBio){
    if(!currentUser) return;
    await setDoc(doc(db, "users", currentUser.uid), { bio: newBio, lastSeen: serverTimestamp() }, { merge:true });
    profile.bio = newBio; render(); showToast("Bio updated", true);
  }
  async function saveEmoji(newEmoji){
    if(!currentUser) return;
    await setDoc(doc(db, "users", currentUser.uid), { emoji: newEmoji, lastSeen: serverTimestamp() }, { merge:true });
    profile.emoji = newEmoji; render(); showToast("Avatar updated", true);
  }
  async function changeUsername(newUsernameRaw){
    if(!currentUser) return;
    const newUsername = newUsernameRaw.trim();
    if (!newUsername.startsWith("$") || newUsername.length < 2){
      showToast("Username must start with $ and be at least 2 chars"); return;
    }
    if (!/^\$[A-Za-z0-9_.]+$/.test(newUsername)){
      showToast("Only letters, numbers, _ and . are allowed after $"); return;
    }
    const newLower = newUsername.toLowerCase();
    try{
      await runTransaction(db, async (tx)=>{
        const meRef = doc(db, "users", currentUser.uid);
        const meSnap = await tx.get(meRef);
        const prevLower = meSnap.exists()? (meSnap.data().usernameLower || "") : "";

        const newRef = doc(db, "usernames", newLower);
        const newSnap = await tx.get(newRef);
        if (newSnap.exists()) throw new Error("That username is already taken.");

        tx.set(newRef, { uid: currentUser.uid });
        tx.set(meRef, { username:newUsername, usernameLower:newLower, lastSeen: serverTimestamp() }, { merge:true });

        if(prevLower && prevLower !== newLower){
          const oldRef = doc(db, "usernames", prevLower);
          const oldSnap = await tx.get(oldRef);
          if(oldSnap.exists() && oldSnap.data().uid === currentUser.uid){
            tx.delete(oldRef);
          }
        }
      });
      profile.username = newUsername; profile.usernameLower = newLower; render(); showToast("Username updated", true);
    }catch(e){ showToast(e.message || "Failed to change username"); }
  }

  // Editing state
  function setEditing(flag){
    editing = flag;
    [nameInput, usernameInput, bioInput, saveBtn, cancelBtn, emojiBtn].forEach(el=> el.disabled = !flag);
    editBtn.disabled = flag;
    editBtn.textContent = flag ? "Editing‚Ä¶" : "Edit";
    if(flag) nameInput.focus();
  }

  editBtn.onclick = ()=> setEditing(true);
  cancelBtn.onclick = ()=>{
    render(); setEditing(false);
  };
  saveBtn.onclick = async ()=>{
    if(!currentUser) return;
    const displayName = nameInput.value.trim();
    const usernameNew = usernameInput.value.trim();
    const bioNew = bioInput.value.trim();

    if(!displayName || !usernameNew){ showToast('Name and username are required'); return; }

    // If username changed, go through reservation
    if(usernameNew !== profile.username){
      await changeUsername(usernameNew);
    }
    // Save displayName and bio
    await setDoc(doc(db,'users', currentUser.uid), { displayName, bio: bioNew, updatedAt: serverTimestamp() }, { merge:true });
    profile.displayName = displayName;
    profile.bio = bioNew;
    render();
    setEditing(false);
    showToast('Profile saved', true);
  };
  emojiBtn.onclick = async ()=>{
    const v = prompt("Enter an emoji for your avatar:", profile.emoji || "üòä");
    if(v){ await saveEmoji(v); }
  };

  // Sharing and copy link
  shareBtn.onclick = async ()=>{
    if(!currentUser) return;
    const url = `${location.origin}${location.pathname}?u=${encodeURIComponent(profile.username || '')}`;
    try{
      if(navigator.share){ await navigator.share({ title:'My LomyChat Profile', text: displayNameEl.textContent, url }); }
      else{ await navigator.clipboard.writeText(url); showToast('Profile link copied!', true); }
    }catch{}
  };
  copyLinkBtn.onclick = async ()=>{
    if(!currentUser) return;
    const url = `${location.origin}${location.pathname}?u=${encodeURIComponent(profile.username || '')}`;
    try{ await navigator.clipboard.writeText(url); showToast('Profile link copied!', true); }
    catch{ showToast('Copy failed'); }
  };

  // QR modal
  qrBtn.onclick = ()=> qrModal.classList.add('show');
  qrBackdrop.onclick = ()=> qrModal.classList.remove('show');
  qrClose.onclick = ()=> qrModal.classList.remove('show');

  // Back button
  backBtn.onclick = ()=>{
    if(backConv && backUser){
      location.href = `chat.html?c=${encodeURIComponent(backConv)}&u=${encodeURIComponent(backUser)}`;
    }else{
      location.href = 'chatlist.html';
    }
  };

  // Sign out
  signOutBtn.onclick = async ()=>{
    try{ await signOut(auth); showToast('Signed out', true); setTimeout(()=> location.href='chatlist.html', 600); }
    catch{ showToast('Sign out failed'); }
  };

  // Auth
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showToast('Please sign in'); return; }
    currentUser = user;
    await loadProfile(user.uid);
    setEditing(false);
  });
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9723b4c6d040cd89',t:'MTc1NTcxMTk0NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
